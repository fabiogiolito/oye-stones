<script>

  const palette = ['#FFAB5C', '#FFD1A5', '#AFE89A', '#EBDEF4', '#D8BFE8', '#CD4D4F', '#FFA7A9', '#F7D183', '#FFE797', '#B3E0CE', '#60B291'];

  const stoneOptions = [
    {
      image: "/stones_1_shade.png",
      shapes: [
        "M286.592 416.005C290.926 489.338 265.259 500.838 209.592 450.505C153.926 400.172 130.592 355.338 139.592 316.005C148.592 276.672 173.426 237.505 214.092 198.505C254.759 159.505 275.926 167.672 277.592 223.005C279.259 278.338 282.259 342.672 286.592 416.005Z",
      ]
    },
    {
      image: "/stones_2_shade.png",
      shapes: [
        "M246.25 342.75C201.583 391.417 166.083 391.417 139.75 342.75C113.417 294.083 113.417 241.583 139.75 185.25C166.083 128.917 201.583 128.917 246.25 185.25C290.917 241.583 290.917 294.083 246.25 342.75Z",
        "M391.014 468.727C361.163 494.187 319.74 494.187 266.746 468.727C213.751 443.267 213.751 417.529 266.746 391.512C319.74 365.496 361.163 365.496 391.014 391.512C420.865 417.529 420.865 443.267 391.014 468.727Z",
      ]
    },
    {
      image: "/stones_3_shade.png",
      shapes: [
        "M329.092 415.505C304.425 488.505 265.592 499.172 212.592 447.505C159.592 395.839 115.092 335.505 79.0919 266.505C43.0919 197.505 67.4253 157.339 152.092 146.005C236.759 134.672 293.592 158.505 322.592 217.505C351.592 276.505 353.759 342.505 329.092 415.505Z",
      ]
    },
    {
      image: "/stones_4_shade.png",
      shapes: [
        "M143.702 268.579C63.1482 280.379 36.902 253.362 64.963 187.528C93.0241 121.695 136.06 79.8869 194.07 62.1037C252.081 44.3206 278.327 71.3375 272.809 143.154C267.291 214.971 224.255 256.779 143.702 268.579Z",
        "M390.5 490C324.167 556.333 251.667 556.333 173 490C94.3333 423.667 94.3333 365.5 173 315.5C251.667 265.5 324.167 265.5 390.5 315.5C456.833 365.5 456.833 423.667 390.5 490Z",
      ]
    },
    {
      image: "/stones_5_shade.png",
      shapes: [
        "M373.625 216.645C318.625 269.311 293.625 247.311 298.625 150.645C303.625 53.9779 331.125 27.6445 381.125 71.6445C431.125 115.645 428.625 163.978 373.625 216.645Z",
        "M135.542 569.476C106.209 588.476 82.0421 562.476 63.0421 491.476C44.0421 420.476 58.7087 410.976 107.042 462.976C155.375 514.976 164.875 550.476 135.542 569.476Z",
        "M364.354 490.939C266.687 519.939 212.687 496.439 202.354 420.439C192.02 344.439 240.854 329.939 348.854 376.939C456.854 423.939 462.02 461.939 364.354 490.939Z",
        "M238.991 132.027C265.84 193.705 241.038 248.156 164.586 295.38C88.1331 342.604 51.4281 325.885 54.4706 245.224C57.513 164.562 82.3149 110.111 128.876 81.8712C175.437 53.6311 212.142 70.3498 238.991 132.027Z",
      ]
    },
    {
      image: "/stones_6_shade.png",
      shapes: [
        "M171.67 497.531C101.193 569.215 67.7201 536.394 71.253 399.067C74.7858 261.741 110.025 225.899 176.969 291.542C243.914 357.184 242.148 425.847 171.67 497.531Z",
        "M312.776 493.005C234.776 561.672 209.276 550.672 236.276 460.005C263.276 369.338 302.276 335.005 353.276 357.005C404.276 379.005 390.776 424.338 312.776 493.005Z",
        "M351.08 298.37C266.414 339.036 216.914 306.37 202.58 200.37C188.247 94.3697 230.58 74.0363 329.58 139.37C428.58 204.703 435.747 257.703 351.08 298.37Z",
      ]
    },
    {
      image: "/stones_7_shade.png",
      shapes: [
        "M347.614 369.469C314.614 402.803 259.78 426.803 183.114 441.469C106.447 456.136 86.947 429.136 124.614 360.469C162.28 291.803 203.614 242.303 248.614 211.969C293.614 181.636 329.614 191.969 356.614 242.969C383.614 293.969 380.614 336.136 347.614 369.469Z",
      ]
    },
    {
      image: "/stones_8_shade.png",
      shapes: [
        "M205.99 383.143C219.268 486.21 195.884 501.192 135.839 428.09C75.7939 354.987 69.1548 303.453 115.922 273.489C162.689 243.525 192.711 280.076 205.99 383.143Z",
        "M361.219 345.37C276.552 386.036 227.052 353.37 212.719 247.37C198.386 141.37 240.719 121.036 339.719 186.37C438.719 251.703 445.886 304.703 361.219 345.37Z",
      ]
    },
    {
      image: "/stones_9_shade.png",
      shapes: [
        "M224.052 451.406C122.417 522.649 81.2831 503.931 100.649 395.252C120.016 286.573 170.833 250.951 253.101 288.387C335.37 325.823 325.687 380.162 224.052 451.406Z",
        "M408.41 297.01C352.41 313.343 308.743 278.01 277.41 191.01C246.077 104.01 274.077 95.8428 361.41 166.51C448.743 237.176 464.41 280.676 408.41 297.01Z",
        "M181.367 109.904C266.036 183.037 261.01 221.521 166.287 225.354C71.564 229.188 29.2292 192.621 39.2823 115.654C49.3355 38.6872 96.6969 36.7704 181.367 109.904Z",
        "M275.691 506.282C335.077 467.845 370.306 464.699 381.38 496.845C392.454 528.991 362.761 548.21 292.302 554.501C221.842 560.793 216.305 544.72 275.691 506.282Z",
      ]
    },
    {
      image: "/stones_10_shade.png",
      shapes: [
        "M248.604 529.621C167.937 545.621 112.104 510.954 81.104 425.621C50.104 340.287 90.4373 332.287 202.104 401.621C313.771 470.954 329.271 513.621 248.604 529.621Z",
        "M360.227 413.864C293.561 475.53 258.561 441.697 255.227 312.364C251.894 183.03 285.227 152.197 355.227 219.864C425.227 287.53 426.894 352.197 360.227 413.864Z",
        "M187.061 259.891C112.728 331.224 88.8944 318.557 115.561 221.891C142.228 125.224 179.394 89.5574 227.061 114.891C274.728 140.224 261.394 188.557 187.061 259.891Z",
      ]
    },
    {
      image: "/stones_11_shade.png",
      shapes: [
        "M196.47 249.497C152.803 276.83 127.97 258.163 121.97 193.497C115.97 128.83 137.803 115.163 187.47 152.497C237.137 189.83 240.137 222.163 196.47 249.497Z",
        "M347.08 492.462C273.746 529.795 238.08 512.795 240.08 441.462C242.08 370.129 278.746 351.462 350.08 385.462C421.413 419.462 420.413 455.129 347.08 492.462Z",
        "M377.352 286.11C301.685 351.443 266.019 322.61 270.352 199.61C274.685 76.6098 312.519 43.9431 383.852 101.61C455.185 159.276 453.019 220.776 377.352 286.11Z",
        "M148.903 494.01C98.9029 534.676 69.2362 506.176 59.9029 408.51C50.5696 310.843 75.5696 290.51 134.903 347.51C194.236 404.51 198.903 453.343 148.903 494.01Z",
      ]
    },
    {
      image: "/stones_12_shade.png",
      shapes: [
        "M50.2469 180.577C69.5255 153.785 115.032 133.399 186.768 119.416C258.503 105.434 275.055 129.571 236.424 191.826C197.793 254.082 161.189 287.401 126.612 291.783C92.0353 296.165 65.8438 285.424 48.0379 259.56C30.2321 233.696 30.9684 207.368 50.2469 180.577Z",
        "M311.554 318.725C323.887 347.725 352.888 360.891 398.554 358.225C444.221 355.558 461.221 332.058 449.554 287.725C437.888 243.391 408.221 194.558 360.554 141.225C312.887 87.8913 289.721 96.8913 291.054 168.225C292.387 239.558 299.221 289.725 311.554 318.725Z",
        "M258.47 510.243C222.47 540.91 177.136 557.076 122.47 558.743C67.8031 560.41 52.1365 537.41 75.4698 489.743C98.8031 442.076 131.97 392.41 174.97 340.743C217.97 289.076 251.636 296.743 275.97 363.743C300.303 430.743 294.47 479.576 258.47 510.243Z",
      ]
    },
  ];

  let colorsFromPalette = false;
  let circlesCount = 10;
  let colorBlur = 10;

  $: stones = randomStones();


  // ====================
  // Functions

  function randomStones() {
    return stoneOptions[Math.floor( Math.random() * stoneOptions.length)];
  }

  function randomColor() {

    // Get color from palette
    if (colorsFromPalette) {
      return palette[Math.floor( Math.random() * palette.length)];
    } 

    // Or return random color
    const hue = Math.floor( Math.random() * 360 );
    return `hsl(${hue}, 80%, 80%)`;
  }

  function randomPosition() {
    const r = Math.random() * 240;
    const cx = Math.random() * 480;
    const cy = Math.random() * 640;
    const fill = randomColor();
    return { r, cx, cy, fill };
  }

  function refresh() {
    location.reload();
  }

</script>

<svelte:body on:click={refresh} />

<div class="options hidden">
  <p>
    <label>
      <input type="checkbox" bind:checked={colorsFromPalette} />
      Limit palette
    </label>
  </p>
  <p>
    Colors
    <input type="range" min="1" max="50" bind:value={circlesCount} />
  </p>
  <p>
    Color blur
    <input type="range" min="1" max="20" bind:value={colorBlur} />
  </p>
</div>

{#key colorsFromPalette}

<div class="canvas" style={`
  --bg-gradient-start: ${randomColor()};
  --bg-gradient-end: ${randomColor()};
  --stones-image: url(${stones.image});
`}>


  <!-- Stones mask definition -->
  <svg viewBox="0 0 480 640" fill="none" xmlns="http://www.w3.org/2000/svg">
    <clipPath id="stonesMask">
      {#each stones.shapes as stone}
        <path fill="white" d={stone} />
      {/each}
    </clipPath>
  </svg>

  <!-- Stones base colors -->
  <svg viewBox="0 0 480 640" fill="none" xmlns="http://www.w3.org/2000/svg">
    {#each stones.shapes as stone}
      <path fill={randomColor()} d={stone} />
    {/each}
  </svg>

  <!-- Fill tints -->
  <svg class="tints" viewBox="0 0 480 640" fill="none" xmlns="http://www.w3.org/2000/svg"
    style="--color-blur: {colorBlur}px;"
  >
    {#each [...Array(circlesCount)] as _}
      <circle {...randomPosition()} opacity="0.5" mask="url(#stonesMask)" />
    {/each}
  </svg>
  
</div>

{/key}

<style>
  :global(html) {
    background-color: #FFF9F1;
    height: 100%;
  }
  :global(body) {
    height: 100%;
    display: grid;
    place-items: center;
  }

  .canvas {
    border-radius: 1rem;
    overflow: hidden;
    width: 480px;
    max-width: 100vw;
    aspect-ratio: 0.75;
    position: relative;
    background: var(--stones-image) no-repeat center, linear-gradient(to bottom, var(--bg-gradient-start), var(--bg-gradient-end));
    background-size: contain;
  }

  svg {
    position: absolute;
    inset: 0;
    mix-blend-mode: color;
  }

  /* Blur circles and apply mask */
  .tints {
    filter: blur(var(--color-blur));
    clip-path: url(#stonesMask);
  } 

  /* Grain */
  .canvas:before {
    content: '';
    position: absolute;
    inset: 0;
    background: url("/grain.png");
  }

  /* Saturate colors */
  .canvas:after {
    content: '';
    position: absolute;
    inset: 0;
    background-color: lime;
    mix-blend-mode: saturation;
    opacity: 0.5;
  }

</style>
